%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Input
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

random(random(randomDirection(dir(1)))).
read(griglia(griglia(player(x(9))))).
read(griglia(griglia(player(y(8))))).
read(griglia(griglia(player(val(0))))).
read(griglia(griglia(player(ch(" "))))).
read(griglia(griglia(direzionePrecedente(-1)))).
read(griglia(griglia(direzione(3)))).
read(griglia(griglia(mappa(0,cella(x(5)))))).
read(griglia(griglia(mappa(1,cella(x(6)))))).
read(griglia(griglia(mappa(2,cella(x(7)))))).
read(griglia(griglia(mappa(3,cella(x(8)))))).
read(griglia(griglia(mappa(4,cella(x(9)))))).
read(griglia(griglia(mappa(5,cella(x(10)))))).
read(griglia(griglia(mappa(6,cella(x(11)))))).
read(griglia(griglia(mappa(7,cella(x(12)))))).
read(griglia(griglia(mappa(8,cella(x(13)))))).
read(griglia(griglia(mappa(9,cella(x(5)))))).
read(griglia(griglia(mappa(10,cella(x(6)))))).
read(griglia(griglia(mappa(11,cella(x(7)))))).
read(griglia(griglia(mappa(12,cella(x(8)))))).
read(griglia(griglia(mappa(13,cella(x(9)))))).
read(griglia(griglia(mappa(14,cella(x(10)))))).
read(griglia(griglia(mappa(15,cella(x(11)))))).
read(griglia(griglia(mappa(16,cella(x(12)))))).
read(griglia(griglia(mappa(17,cella(x(13)))))).
read(griglia(griglia(mappa(18,cella(x(5)))))).
read(griglia(griglia(mappa(19,cella(x(6)))))).
read(griglia(griglia(mappa(20,cella(x(7)))))).
read(griglia(griglia(mappa(21,cella(x(8)))))).
read(griglia(griglia(mappa(22,cella(x(9)))))).
read(griglia(griglia(mappa(23,cella(x(10)))))).
read(griglia(griglia(mappa(24,cella(x(11)))))).
read(griglia(griglia(mappa(25,cella(x(12)))))).
read(griglia(griglia(mappa(26,cella(x(13)))))).
read(griglia(griglia(mappa(27,cella(x(5)))))).
read(griglia(griglia(mappa(28,cella(x(6)))))).
read(griglia(griglia(mappa(29,cella(x(7)))))).
read(griglia(griglia(mappa(30,cella(x(8)))))).
read(griglia(griglia(mappa(31,cella(x(9)))))).
read(griglia(griglia(mappa(32,cella(x(10)))))).
read(griglia(griglia(mappa(33,cella(x(11)))))).
read(griglia(griglia(mappa(34,cella(x(12)))))).
read(griglia(griglia(mappa(35,cella(x(13)))))).
read(griglia(griglia(mappa(36,cella(x(5)))))).
read(griglia(griglia(mappa(37,cella(x(6)))))).
read(griglia(griglia(mappa(38,cella(x(7)))))).
read(griglia(griglia(mappa(39,cella(x(8)))))).
read(griglia(griglia(mappa(40,cella(x(9)))))).
read(griglia(griglia(mappa(41,cella(x(10)))))).
read(griglia(griglia(mappa(42,cella(x(11)))))).
read(griglia(griglia(mappa(43,cella(x(12)))))).
read(griglia(griglia(mappa(44,cella(x(13)))))).
read(griglia(griglia(mappa(45,cella(x(5)))))).
read(griglia(griglia(mappa(46,cella(x(6)))))).
read(griglia(griglia(mappa(47,cella(x(7)))))).
read(griglia(griglia(mappa(48,cella(x(8)))))).
read(griglia(griglia(mappa(49,cella(x(9)))))).
read(griglia(griglia(mappa(50,cella(x(10)))))).
read(griglia(griglia(mappa(51,cella(x(11)))))).
read(griglia(griglia(mappa(52,cella(x(12)))))).
read(griglia(griglia(mappa(53,cella(x(13)))))).
read(griglia(griglia(mappa(54,cella(x(5)))))).
read(griglia(griglia(mappa(55,cella(x(6)))))).
read(griglia(griglia(mappa(56,cella(x(7)))))).
read(griglia(griglia(mappa(57,cella(x(8)))))).
read(griglia(griglia(mappa(58,cella(x(9)))))).
read(griglia(griglia(mappa(59,cella(x(10)))))).
read(griglia(griglia(mappa(60,cella(x(11)))))).
read(griglia(griglia(mappa(61,cella(x(12)))))).
read(griglia(griglia(mappa(62,cella(x(13)))))).
read(griglia(griglia(mappa(63,cella(x(5)))))).
read(griglia(griglia(mappa(64,cella(x(6)))))).
read(griglia(griglia(mappa(65,cella(x(7)))))).
read(griglia(griglia(mappa(66,cella(x(8)))))).
read(griglia(griglia(mappa(67,cella(x(9)))))).
read(griglia(griglia(mappa(68,cella(x(10)))))).
read(griglia(griglia(mappa(69,cella(x(11)))))).
read(griglia(griglia(mappa(70,cella(x(12)))))).
read(griglia(griglia(mappa(71,cella(x(13)))))).
read(griglia(griglia(mappa(72,cella(x(5)))))).
read(griglia(griglia(mappa(73,cella(x(6)))))).
read(griglia(griglia(mappa(74,cella(x(7)))))).
read(griglia(griglia(mappa(75,cella(x(8)))))).
read(griglia(griglia(mappa(76,cella(x(9)))))).
read(griglia(griglia(mappa(77,cella(x(10)))))).
read(griglia(griglia(mappa(78,cella(x(11)))))).
read(griglia(griglia(mappa(79,cella(x(12)))))).
read(griglia(griglia(mappa(80,cella(x(13)))))).
read(griglia(griglia(mappa(0,cella(y(6)))))).
read(griglia(griglia(mappa(1,cella(y(6)))))).
read(griglia(griglia(mappa(2,cella(y(6)))))).
read(griglia(griglia(mappa(3,cella(y(6)))))).
read(griglia(griglia(mappa(4,cella(y(6)))))).
read(griglia(griglia(mappa(5,cella(y(6)))))).
read(griglia(griglia(mappa(6,cella(y(6)))))).
read(griglia(griglia(mappa(7,cella(y(6)))))).
read(griglia(griglia(mappa(8,cella(y(6)))))).
read(griglia(griglia(mappa(9,cella(y(7)))))).
read(griglia(griglia(mappa(10,cella(y(7)))))).
read(griglia(griglia(mappa(11,cella(y(7)))))).
read(griglia(griglia(mappa(12,cella(y(7)))))).
read(griglia(griglia(mappa(13,cella(y(7)))))).
read(griglia(griglia(mappa(14,cella(y(7)))))).
read(griglia(griglia(mappa(15,cella(y(7)))))).
read(griglia(griglia(mappa(16,cella(y(7)))))).
read(griglia(griglia(mappa(17,cella(y(7)))))).
read(griglia(griglia(mappa(18,cella(y(8)))))).
read(griglia(griglia(mappa(19,cella(y(8)))))).
read(griglia(griglia(mappa(20,cella(y(8)))))).
read(griglia(griglia(mappa(21,cella(y(8)))))).
read(griglia(griglia(mappa(22,cella(y(8)))))).
read(griglia(griglia(mappa(23,cella(y(8)))))).
read(griglia(griglia(mappa(24,cella(y(8)))))).
read(griglia(griglia(mappa(25,cella(y(8)))))).
read(griglia(griglia(mappa(26,cella(y(8)))))).
read(griglia(griglia(mappa(27,cella(y(9)))))).
read(griglia(griglia(mappa(28,cella(y(9)))))).
read(griglia(griglia(mappa(29,cella(y(9)))))).
read(griglia(griglia(mappa(30,cella(y(9)))))).
read(griglia(griglia(mappa(31,cella(y(9)))))).
read(griglia(griglia(mappa(32,cella(y(9)))))).
read(griglia(griglia(mappa(33,cella(y(9)))))).
read(griglia(griglia(mappa(34,cella(y(9)))))).
read(griglia(griglia(mappa(35,cella(y(9)))))).
read(griglia(griglia(mappa(36,cella(y(10)))))).
read(griglia(griglia(mappa(37,cella(y(10)))))).
read(griglia(griglia(mappa(38,cella(y(10)))))).
read(griglia(griglia(mappa(39,cella(y(10)))))).
read(griglia(griglia(mappa(40,cella(y(10)))))).
read(griglia(griglia(mappa(41,cella(y(10)))))).
read(griglia(griglia(mappa(42,cella(y(10)))))).
read(griglia(griglia(mappa(43,cella(y(10)))))).
read(griglia(griglia(mappa(44,cella(y(10)))))).
read(griglia(griglia(mappa(45,cella(y(11)))))).
read(griglia(griglia(mappa(46,cella(y(11)))))).
read(griglia(griglia(mappa(47,cella(y(11)))))).
read(griglia(griglia(mappa(48,cella(y(11)))))).
read(griglia(griglia(mappa(49,cella(y(11)))))).
read(griglia(griglia(mappa(50,cella(y(11)))))).
read(griglia(griglia(mappa(51,cella(y(11)))))).
read(griglia(griglia(mappa(52,cella(y(11)))))).
read(griglia(griglia(mappa(53,cella(y(11)))))).
read(griglia(griglia(mappa(54,cella(y(12)))))).
read(griglia(griglia(mappa(55,cella(y(12)))))).
read(griglia(griglia(mappa(56,cella(y(12)))))).
read(griglia(griglia(mappa(57,cella(y(12)))))).
read(griglia(griglia(mappa(58,cella(y(12)))))).
read(griglia(griglia(mappa(59,cella(y(12)))))).
read(griglia(griglia(mappa(60,cella(y(12)))))).
read(griglia(griglia(mappa(61,cella(y(12)))))).
read(griglia(griglia(mappa(62,cella(y(12)))))).
read(griglia(griglia(mappa(63,cella(y(13)))))).
read(griglia(griglia(mappa(64,cella(y(13)))))).
read(griglia(griglia(mappa(65,cella(y(13)))))).
read(griglia(griglia(mappa(66,cella(y(13)))))).
read(griglia(griglia(mappa(67,cella(y(13)))))).
read(griglia(griglia(mappa(68,cella(y(13)))))).
read(griglia(griglia(mappa(69,cella(y(13)))))).
read(griglia(griglia(mappa(70,cella(y(13)))))).
read(griglia(griglia(mappa(71,cella(y(13)))))).
read(griglia(griglia(mappa(72,cella(y(14)))))).
read(griglia(griglia(mappa(73,cella(y(14)))))).
read(griglia(griglia(mappa(74,cella(y(14)))))).
read(griglia(griglia(mappa(75,cella(y(14)))))).
read(griglia(griglia(mappa(76,cella(y(14)))))).
read(griglia(griglia(mappa(77,cella(y(14)))))).
read(griglia(griglia(mappa(78,cella(y(14)))))).
read(griglia(griglia(mappa(79,cella(y(14)))))).
read(griglia(griglia(mappa(80,cella(y(14)))))).
read(griglia(griglia(mappa(0,cella(val(2)))))).
read(griglia(griglia(mappa(1,cella(val(2)))))).
read(griglia(griglia(mappa(2,cella(val(2)))))).
read(griglia(griglia(mappa(3,cella(val(2)))))).
read(griglia(griglia(mappa(4,cella(val(2)))))).
read(griglia(griglia(mappa(5,cella(val(2)))))).
read(griglia(griglia(mappa(6,cella(val(2)))))).
read(griglia(griglia(mappa(7,cella(val(2)))))).
read(griglia(griglia(mappa(8,cella(val(2)))))).
read(griglia(griglia(mappa(9,cella(val(2)))))).
read(griglia(griglia(mappa(10,cella(val(0)))))).
read(griglia(griglia(mappa(11,cella(val(0)))))).
read(griglia(griglia(mappa(12,cella(val(0)))))).
read(griglia(griglia(mappa(13,cella(val(5)))))).
read(griglia(griglia(mappa(14,cella(val(0)))))).
read(griglia(griglia(mappa(15,cella(val(0)))))).
read(griglia(griglia(mappa(16,cella(val(0)))))).
read(griglia(griglia(mappa(17,cella(val(2)))))).
read(griglia(griglia(mappa(18,cella(val(2)))))).
read(griglia(griglia(mappa(19,cella(val(0)))))).
read(griglia(griglia(mappa(20,cella(val(0)))))).
read(griglia(griglia(mappa(21,cella(val(0)))))).
read(griglia(griglia(mappa(22,cella(val(0)))))).
read(griglia(griglia(mappa(23,cella(val(0)))))).
read(griglia(griglia(mappa(24,cella(val(0)))))).
read(griglia(griglia(mappa(25,cella(val(0)))))).
read(griglia(griglia(mappa(26,cella(val(2)))))).
read(griglia(griglia(mappa(27,cella(val(2)))))).
read(griglia(griglia(mappa(28,cella(val(0)))))).
read(griglia(griglia(mappa(29,cella(val(0)))))).
read(griglia(griglia(mappa(30,cella(val(0)))))).
read(griglia(griglia(mappa(31,cella(val(4)))))).
read(griglia(griglia(mappa(32,cella(val(0)))))).
read(griglia(griglia(mappa(33,cella(val(0)))))).
read(griglia(griglia(mappa(34,cella(val(6)))))).
read(griglia(griglia(mappa(35,cella(val(2)))))).
read(griglia(griglia(mappa(36,cella(val(2)))))).
read(griglia(griglia(mappa(37,cella(val(0)))))).
read(griglia(griglia(mappa(38,cella(val(0)))))).
read(griglia(griglia(mappa(39,cella(val(0)))))).
read(griglia(griglia(mappa(40,cella(val(0)))))).
read(griglia(griglia(mappa(41,cella(val(0)))))).
read(griglia(griglia(mappa(42,cella(val(0)))))).
read(griglia(griglia(mappa(43,cella(val(0)))))).
read(griglia(griglia(mappa(44,cella(val(2)))))).
read(griglia(griglia(mappa(45,cella(val(2)))))).
read(griglia(griglia(mappa(46,cella(val(0)))))).
read(griglia(griglia(mappa(47,cella(val(0)))))).
read(griglia(griglia(mappa(48,cella(val(0)))))).
read(griglia(griglia(mappa(49,cella(val(0)))))).
read(griglia(griglia(mappa(50,cella(val(0)))))).
read(griglia(griglia(mappa(51,cella(val(0)))))).
read(griglia(griglia(mappa(52,cella(val(0)))))).
read(griglia(griglia(mappa(53,cella(val(2)))))).
read(griglia(griglia(mappa(54,cella(val(2)))))).
read(griglia(griglia(mappa(55,cella(val(0)))))).
read(griglia(griglia(mappa(56,cella(val(0)))))).
read(griglia(griglia(mappa(57,cella(val(0)))))).
read(griglia(griglia(mappa(58,cella(val(0)))))).
read(griglia(griglia(mappa(59,cella(val(0)))))).
read(griglia(griglia(mappa(60,cella(val(0)))))).
read(griglia(griglia(mappa(61,cella(val(0)))))).
read(griglia(griglia(mappa(62,cella(val(2)))))).
read(griglia(griglia(mappa(63,cella(val(2)))))).
read(griglia(griglia(mappa(64,cella(val(0)))))).
read(griglia(griglia(mappa(65,cella(val(0)))))).
read(griglia(griglia(mappa(66,cella(val(0)))))).
read(griglia(griglia(mappa(67,cella(val(0)))))).
read(griglia(griglia(mappa(68,cella(val(0)))))).
read(griglia(griglia(mappa(69,cella(val(0)))))).
read(griglia(griglia(mappa(70,cella(val(0)))))).
read(griglia(griglia(mappa(71,cella(val(2)))))).
read(griglia(griglia(mappa(72,cella(val(2)))))).
read(griglia(griglia(mappa(73,cella(val(2)))))).
read(griglia(griglia(mappa(74,cella(val(2)))))).
read(griglia(griglia(mappa(75,cella(val(2)))))).
read(griglia(griglia(mappa(76,cella(val(2)))))).
read(griglia(griglia(mappa(77,cella(val(2)))))).
read(griglia(griglia(mappa(78,cella(val(2)))))).
read(griglia(griglia(mappa(79,cella(val(2)))))).
read(griglia(griglia(mappa(80,cella(val(2)))))).
read(griglia(griglia(mappa(0,cella(ch("#")))))).
read(griglia(griglia(mappa(1,cella(ch("#")))))).
read(griglia(griglia(mappa(2,cella(ch("#")))))).
read(griglia(griglia(mappa(3,cella(ch("#")))))).
read(griglia(griglia(mappa(4,cella(ch("#")))))).
read(griglia(griglia(mappa(5,cella(ch("#")))))).
read(griglia(griglia(mappa(6,cella(ch("#")))))).
read(griglia(griglia(mappa(7,cella(ch("#")))))).
read(griglia(griglia(mappa(8,cella(ch("#")))))).
read(griglia(griglia(mappa(9,cella(ch("#")))))).
read(griglia(griglia(mappa(10,cella(ch(" ")))))).
read(griglia(griglia(mappa(11,cella(ch(" ")))))).
read(griglia(griglia(mappa(12,cella(ch(" ")))))).
read(griglia(griglia(mappa(13,cella(ch("@")))))).
read(griglia(griglia(mappa(14,cella(ch(" ")))))).
read(griglia(griglia(mappa(15,cella(ch(" ")))))).
read(griglia(griglia(mappa(16,cella(ch(" ")))))).
read(griglia(griglia(mappa(17,cella(ch("#")))))).
read(griglia(griglia(mappa(18,cella(ch("#")))))).
read(griglia(griglia(mappa(19,cella(ch(" ")))))).
read(griglia(griglia(mappa(20,cella(ch(" ")))))).
read(griglia(griglia(mappa(21,cella(ch(" ")))))).
read(griglia(griglia(mappa(22,cella(ch(" ")))))).
read(griglia(griglia(mappa(23,cella(ch(" ")))))).
read(griglia(griglia(mappa(24,cella(ch(" ")))))).
read(griglia(griglia(mappa(25,cella(ch(" ")))))).
read(griglia(griglia(mappa(26,cella(ch("#")))))).
read(griglia(griglia(mappa(27,cella(ch("#")))))).
read(griglia(griglia(mappa(28,cella(ch(" ")))))).
read(griglia(griglia(mappa(29,cella(ch(" ")))))).
read(griglia(griglia(mappa(30,cella(ch(" ")))))).
read(griglia(griglia(mappa(31,cella(ch("$")))))).
read(griglia(griglia(mappa(32,cella(ch(" ")))))).
read(griglia(griglia(mappa(33,cella(ch(" ")))))).
read(griglia(griglia(mappa(34,cella(ch(".")))))).
read(griglia(griglia(mappa(35,cella(ch("#")))))).
read(griglia(griglia(mappa(36,cella(ch("#")))))).
read(griglia(griglia(mappa(37,cella(ch(" ")))))).
read(griglia(griglia(mappa(38,cella(ch(" ")))))).
read(griglia(griglia(mappa(39,cella(ch(" ")))))).
read(griglia(griglia(mappa(40,cella(ch(" ")))))).
read(griglia(griglia(mappa(41,cella(ch(" ")))))).
read(griglia(griglia(mappa(42,cella(ch(" ")))))).
read(griglia(griglia(mappa(43,cella(ch(" ")))))).
read(griglia(griglia(mappa(44,cella(ch("#")))))).
read(griglia(griglia(mappa(45,cella(ch("#")))))).
read(griglia(griglia(mappa(46,cella(ch(" ")))))).
read(griglia(griglia(mappa(47,cella(ch(" ")))))).
read(griglia(griglia(mappa(48,cella(ch(" ")))))).
read(griglia(griglia(mappa(49,cella(ch(" ")))))).
read(griglia(griglia(mappa(50,cella(ch(" ")))))).
read(griglia(griglia(mappa(51,cella(ch(" ")))))).
read(griglia(griglia(mappa(52,cella(ch(" ")))))).
read(griglia(griglia(mappa(53,cella(ch("#")))))).
read(griglia(griglia(mappa(54,cella(ch("#")))))).
read(griglia(griglia(mappa(55,cella(ch(" ")))))).
read(griglia(griglia(mappa(56,cella(ch(" ")))))).
read(griglia(griglia(mappa(57,cella(ch(" ")))))).
read(griglia(griglia(mappa(58,cella(ch(" ")))))).
read(griglia(griglia(mappa(59,cella(ch(" ")))))).
read(griglia(griglia(mappa(60,cella(ch(" ")))))).
read(griglia(griglia(mappa(61,cella(ch(" ")))))).
read(griglia(griglia(mappa(62,cella(ch("#")))))).
read(griglia(griglia(mappa(63,cella(ch("#")))))).
read(griglia(griglia(mappa(64,cella(ch(" ")))))).
read(griglia(griglia(mappa(65,cella(ch(" ")))))).
read(griglia(griglia(mappa(66,cella(ch(" ")))))).
read(griglia(griglia(mappa(67,cella(ch(" ")))))).
read(griglia(griglia(mappa(68,cella(ch(" ")))))).
read(griglia(griglia(mappa(69,cella(ch(" ")))))).
read(griglia(griglia(mappa(70,cella(ch(" ")))))).
read(griglia(griglia(mappa(71,cella(ch("#")))))).
read(griglia(griglia(mappa(72,cella(ch("#")))))).
read(griglia(griglia(mappa(73,cella(ch("#")))))).
read(griglia(griglia(mappa(74,cella(ch("#")))))).
read(griglia(griglia(mappa(75,cella(ch("#")))))).
read(griglia(griglia(mappa(76,cella(ch("#")))))).
read(griglia(griglia(mappa(77,cella(ch("#")))))).
read(griglia(griglia(mappa(78,cella(ch("#")))))).
read(griglia(griglia(mappa(79,cella(ch("#")))))).
read(griglia(griglia(mappa(80,cella(ch("#")))))).


direction(0,10,10). %% fermo
direction(1,20,10). %% sopra
direction(2,0,10).  %% sotto
direction(3,10,20). %% destra
direction(4,10,0).  %% sinitra

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Parsing input
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% MAPPA %%
celle(X, Y, I, C) :- read(griglia(griglia(mappa(I,cella(x(X)))))), read(griglia(griglia(mappa(I,cella(y(Y)))))), read(griglia(griglia(mappa(I,cella(val(C)))))).
muro(X, Y, I) :- celle(X, Y, I, C), C = 2.
libero(X, Y, I) :- celle(X, Y, I, C), C = 0.

%% PLAYER %%
player(X, Y, I) :- read(griglia(griglia(mappa(I,cella(x(X)))))), read(griglia(griglia(mappa(I,cella(y(Y)))))), read(griglia(griglia(player(x(X))))), read(griglia(griglia(player(y(Y))))).

% %% TARGET %%
target(X, Y, I) :- celle(X, Y, I, C), C = 6.

%% Trovo le scatole.
box(X, Y, I)  :- celle(X, Y, I, C), C = 4.

%% Ultima e penultima direzione
penultimaDir(X) :- read(griglia(griglia(direzionePrecedente(X)))).
ultimaDir(X) :- read(griglia(griglia(direzione(X)))).

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Elaborazione
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% Calcolo le distanze (manhattan) con ogni scatola %%
distanzaScatole(ID, Distanza) :- player(X1, Y1, IP), box(X2, Y2, ID), Distanza = X1-X2+Y1-Y2, X1 >= X2, Y1 >= Y2.
distanzaScatole(ID, Distanza) :- player(X1, Y1, IP), box(X2, Y2, ID), Distanza = X2-X1+Y1-Y2, X1 < X2, Y1 >= Y2.
distanzaScatole(ID, Distanza) :- player(X1, Y1, IP), box(X2, Y2, ID), Distanza = X1-X2+Y2-Y1, X1 >= X2, Y1 < Y2.
distanzaScatole(ID, Distanza) :- player(X1, Y1, IP), box(X2, Y2, ID), Distanza = X2-X1+Y2-Y1, X1 < X2, Y1 < Y2. 

scatolaPiuVicina(ID) :- distanzaScatole(ID, DM), #min{Distanza: distanzaScatole(ID, Distanza)} = DM.

vado(N) | nonVado(N) :- direction(N, DX, DY).
:- vado(N1), vado(N2), N1 != N2. % Ci evitiamo un count?
v :- vado(N).
:- not v.

nuovaPosizionePlayer(D, X1, Y) :- vado(D), D=1, player(X, Y, ID), X1 = X+1.
nuovaPosizionePlayer(D, X1, Y) :- vado(D), D=2, player(X, Y, ID), X1 = X-1.
nuovaPosizionePlayer(D, X, Y1) :- vado(D), D=3, player(X, Y, ID), Y1 = Y+1.
nuovaPosizionePlayer(D, X, Y1) :- vado(D), D=4, player(X, Y, ID), Y1 = Y-1.
:- nuovaPosizionePlayer(D, X,Y), muro(X,Y,_).


nuoveDistanza(Dir,Dist) :- not scatola, nuovaPosizionePlayer(Dir, X1,Y1), scatolaPiuVicina(ID), box(X2, Y2, ID), Dist = X1-X2+Y1-Y2, X1 >= X2, Y1 >= Y2.
nuoveDistanza(Dir,Dist) :- not scatola, nuovaPosizionePlayer(Dir, X1,Y1), scatolaPiuVicina(ID), box(X2, Y2, ID), Dist = X2-X1+Y1-Y2, X1 < X2, Y1 >= Y2.
nuoveDistanza(Dir,Dist) :- not scatola, nuovaPosizionePlayer(Dir, X1,Y1), scatolaPiuVicina(ID), box(X2, Y2, ID), Dist = X1-X2+Y2-Y1, X1 >= X2, Y1 < Y2.
nuoveDistanza(Dir,Dist) :- not scatola, nuovaPosizionePlayer(Dir, X1,Y1), scatolaPiuVicina(ID), box(X2, Y2, ID), Dist = X2-X1+Y2-Y1, X1 < X2, Y1 < Y2. 
:- nuovaDistanza(Dir, Dist), distanzaScatole(Id, DistP), Dist > DistP, not scatola.

:~ vado(0).  [1@2]
:~ nuoveDistanza(Dir, Dist). [Dist@1]

scatolaTrovata(D) :- player(_,_,NP), box(_,_,NB), NP=NB-1, D=1.
scatolaTrovata(D) :- player(_,_,NP), box(_,_,NB), NP=NB+1, D=2. 
scatolaTrovata(D) :- player(_,_,NP), box(_,_,NB), NP=NB-9, D=3. 
scatolaTrovata(D) :- player(_,_,NP), box(_,_,NB), NP=NB+9, D=4.
scatola :- scatolaTrovata(D).

giroAttorno(M1,M2) :- player(_,_,NP), scatolaTrovata(D), vado(D1), D = 3, D1 = 2, M1=1, M2=3.
giroAttorno(M1,M2) :- player(_,_,NP), scatolaTrovata(D), vado(D1), D = 3, D1 = 1, M1=2, M2=3.
giroAttorno(M1,M2) :- player(_,_,NP), scatolaTrovata(D), vado(D1), D = 4, D1 = 2, M1=1, M2=4.
giroAttorno(M1,M2) :- player(_,_,NP), scatolaTrovata(D), vado(D1), D = 4, D1 = 1, M1=2, M2=4.

giroAttorno(M1,M2) :- player(_,_,NP), scatolaTrovata(D), vado(D1), D = 1, D1 = 3, M1=4, M2=1.
giroAttorno(M1,M2) :- player(_,_,NP), scatolaTrovata(D), vado(D1), D = 1, D1 = 4, M1=3, M2=1.
giroAttorno(M1,M2) :- player(_,_,NP), scatolaTrovata(D), vado(D1), D = 2, D1 = 3, M1=4, M2=2.
giroAttorno(M1,M2) :- player(_,_,NP), scatolaTrovata(D), vado(D1), D = 2, D1 = 4, M1=3, M2=2.

angolo :- giroAttorno(M1, M2).

targetLibero(X, Y, I) :- target(X, Y, I), not box(X, Y, I).

distanzaTarget(ID, Distanza) :- scatolaPiuVicina(IB), box(X1, Y1, IB), targetLibero(X2, Y2, ID), Distanza = X1-X2+Y1-Y2, X1 >= X2, Y1 >= Y2.
distanzaTarget(ID, Distanza) :- scatolaPiuVicina(IB), box(X1, Y1, IB), targetLibero(X2, Y2, ID), Distanza = X2-X1+Y1-Y2, X1 < X2, Y1 >= Y2.
distanzaTarget(ID, Distanza) :- scatolaPiuVicina(IB), box(X1, Y1, IB), targetLibero(X2, Y2, ID), Distanza = X1-X2+Y2-Y1, X1 >= X2, Y1 < Y2.
distanzaTarget(ID, Distanza) :- scatolaPiuVicina(IB), box(X1, Y1, IB), targetLibero(X2, Y2, ID), Distanza = X2-X1+Y2-Y1, X1 < X2, Y1 < Y2. 
targetPiuVicino(ID) :- distanzaTarget(ID, DM), #min{Distanza: distanzaTarget(ID, Distanza)} = DM.

nuovaPosizioneScatola(D, X1, Y) :- vado(D), D=1, box(X, Y, ID), X1 = X+1, scatolaPiuVicina(ID).
nuovaPosizioneScatola(D, X1, Y) :- vado(D), D=2, box(X, Y, ID), X1 = X-1, scatolaPiuVicina(ID).
nuovaPosizioneScatola(D, X, Y1) :- vado(D), D=3, box(X, Y, ID), Y1 = Y+1, scatolaPiuVicina(ID).
nuovaPosizioneScatola(D, X, Y1) :- vado(D), D=4, box(X, Y, ID), Y1 = Y-1, scatolaPiuVicina(ID).
:- nuovaPosizioneScatola(D, X,Y), muro(X,Y,_).

nuoveDistanza(Dir,Dist) :- scatola, nuovaPosizioneScatola(Dir, X1,Y1), targetPiuVicino(ID), targetLibero(X2, Y2, ID), Dist = X1-X2+Y1-Y2, X1 >= X2, Y1 >= Y2.
nuoveDistanza(Dir,Dist) :- scatola, nuovaPosizioneScatola(Dir, X1,Y1), targetPiuVicino(ID), targetLibero(X2, Y2, ID), Dist = X2-X1+Y1-Y2, X1 < X2, Y1 >= Y2.
nuoveDistanza(Dir,Dist) :- scatola, nuovaPosizioneScatola(Dir, X1,Y1), targetPiuVicino(ID), targetLibero(X2, Y2, ID), Dist = X1-X2+Y2-Y1, X1 >= X2, Y1 < Y2.
nuoveDistanza(Dir,Dist) :- scatola, nuovaPosizioneScatola(Dir, X1,Y1), targetPiuVicino(ID), targetLibero(X2, Y2, ID), Dist = X2-X1+Y2-Y1, X1 < X2, Y1 < Y2. 
:- nuovaDistanza(Dir, Dist), distanzaTarget(Id, DistP), Dist > DistP, scatola.

% Ottimizzazione
% Per non fare avanti e dietro o sopra e sotto
:- penultima(X), ultimaDir(Y), vado(X), X != Y.
% Se scatta l'angolo, prendilo --- no, si blocca all'inizio, non serve, trova un modo differente.
% :~ not angolo. [1@3]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% OUTPUT (Direzione da prendere) %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
direzioneDaPrendere(D) :- vado(D).

% direzioneDaPrendere(D) :- box(_, _, PI), inPath(PI, SI), SI=PI+1, D=1, st. %% Destra
% direzioneDaPrendere(D) :- box(_, _, PI), inPath(PI, SI), SI=PI-1, D=2, st. %% Sinistra
% direzioneDaPrendere(D) :- box(_, _, PI), inPath(PI, SI), SI=PI-9, D=4, st. %% Sopra
% direzioneDaPrendere(D) :- box(_, _, PI), inPath(PI, SI), SI=PI+9, D=3, st. %% Sotto

playerNextPos(X, Y) :- player(XP, YP, P), inPath(P, I), celle(X, Y, I, C).

playerNextId(I) :- player(XP, YP, P), direzioneDaPrendere(D), D = 1, I = P + 1.
playerNextId(I) :- player(XP, YP, P), direzioneDaPrendere(D), D = 2, I = P - 1.
playerNextId(I) :- player(XP, YP, P), direzioneDaPrendere(D), D = 3, I = P + 9.
playerNextId(I) :- player(XP, YP, P), direzioneDaPrendere(D), D = 4, I = P - 9.

setOnActuator(scrivo(gameManager(gameManager(x(X))))) :- giroAttorno(D,D2), direction(D,X,Y), angolo.
setOnActuator(scrivo(gameManager(gameManager(y(Y))))) :- giroAttorno(D,D2), direction(D,X,Y), angolo.
setOnActuator(scrivo(gameManager(gameManager(x2(X))))) :- giroAttorno(D1, D2), direction(D2,X,Y), angolo.
setOnActuator(scrivo(gameManager(gameManager(y2(Y))))) :- giroAttorno(D1, D2), direction(D2,X,Y), angolo.

setOnActuator(scrivo(gameManager(gameManager(x(X))))) :- direzioneDaPrendere(D), direction(D,X,Y), not angolo.
setOnActuator(scrivo(gameManager(gameManager(y(Y))))) :- direzioneDaPrendere(D), direction(D,X,Y), not angolo.
setOnActuator(scrivo(gameManager(gameManager(x2(X))))) :- X = -1, not angolo.
setOnActuator(scrivo(gameManager(gameManager(y2(Y))))) :- Y = -1, not angolo.

